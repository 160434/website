#!/usr/bin/env ruby

require 'rubygems'
require 'mongo'

def run s
  puts s
  #puts `#{s}`
end

db = Mongo::Connection.new.db 'nodeknockout'
db_teams = db.collection 'Team'
db_people = db.collection 'Person'

db_teams.find().each do |t|
  app = 'nko-' + t['slug']

  # create app
  run "heroku create --stack beech #{app}"

  # post deploy hook
  run "heroku addons:add custom_domains:basic --app #{app}"
  run "heroku addons:add deployhooks:http url=http://nodeknockout.com/deploys --app #{app}"

  # give them the app
  # TODO add all users
  people = t['members'].map { |p| db_people.find_one p['_id'] }
  people.each do |p|
    run "heroku sharing:add #{p['email']} --app #{app}"
  end
  run "heroku sharing:add all@nodeknockout.com --app #{app}"

  # transfer ownership
  run "heroku sharing:transfer #{people.first['email']} --app #{app}"
  puts "\n"
end
